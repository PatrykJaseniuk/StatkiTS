## Przerabiam system 

System bdzie si skada z dw贸ch element贸w:
+ Stanu wiata
+ Modyfikatora wiata
wiat jest zbudowany z element贸w, kt贸re s ze sob powizane, tworzc r贸偶ne struktury. Element ka偶dej z klas w momencie powstania zapisuje si do tablicy modyfikatora element贸w tej klasy. Ka偶da klasa element贸w posiada sw贸j modyfikator, kt贸ry modyfikuje wszystkie elementy (obiekty) danej klasy.
Wszystkie modyfikatory element贸w s wywoywane w odpowiedniej kolejnoci (nawet asynchronicznie, a mo偶e nawet r贸wnolegle) w modyfikatorze wiata. 

Nale偶y zachowa szczeg贸ln ostro偶no ze zmiennymi globalnymi (updatery).

Aby uruchomi testy obiekt贸w, kt贸re korzystaj ze zmiennych globalnych przegldarki, nale偶y zasymulowa takie rodowisko. Do tego celu u偶ywam mo偶liwoci konfiguracji `jest` :
+ pobieram odpowiednie rodowisko testowe: ```
``` bash 
npm install jest-environment-jsdom
```
+ modyfikuje plik `jest.config.js`
``` js
testEnvironment: 'jsdom',
```



## Stabilno modelu dynamiki

Model jest stabilny, je偶eli postpuje zgodne z zasad zachowania pdu 
```ts
test('momentum conservation', () => {
let forces: Force[] = [];
forces.push(force1);
forces.push(force2);
let momentum0 = calculateMomentum(forces);
for (let i = 0; i < 10000; i++) {
dynamicModelUpdate();
}
let momentum1 = calculateMomentum(forces);
expect(momentum0.distanceTo(momentum1) < 0.00001 * momentum0.length()).toBeTruthy();
});  
```

Wyznaczenie poo偶enia obiekt贸w w chwili `t` wymaga scakowania r贸wnania ruchu Newtona

Do tego celu u偶yj integratora Vertela: [[https://en.wikipedia.org/wiki/Verlet_integration]]

Algorytm integratora Vertela z przykadu na wiki nie dziaa, jak powinien, wic pozostaj przy pierwotnej wersji.

Pd jest stay, je偶eli `dt` jest dostatecznie mae. Istnieje takie `dtMax` poni偶ej, kt贸rego system jest stabilny.  Jak podaje Wikipedia `dtMax` jest zwizane z najwiksz czstoci drgania kt贸regokolwiek molekuu systemu. [[https://en.wikipedia.org/wiki/Energy_drift]]

```
dtMax = 2^(1/2)/omega
```
![{\displaystyle \Delta t<{\frac {\sqrt {2}}{\omega }}\approx 0.225p}](https://wikimedia.org/api/rest_v1/media/math/render/svg/2ce85b09695b0dbc73db5971451e712ed4f9f114)

Omega jest staa, je偶eli oddziaywania si nie zmieniaj, to znaczy nie powstaj i nie znikaj nowe obiekty klasy [Interaction](Interaction.ts). Omega jest r贸wna 
```
omega = (k/m)^(1/2)
```
gdzie:
+ `k` - wsp贸czynnik spr偶ystoci
+ `m` - masa

Dla czstek, kt贸re podlegaj wielu oddziaywaniom, zsumuj wsp贸czynnik spr偶ystoci, tak jak by spr偶yny byy poczone r贸wnolegle.

Teraz znajduj najwiksz omeg i na jej podstawie wyznaczam `dtMax` poni偶ej kt贸rej system jest stabilny. 
Ciekawe , 偶e to dziaa:

```ts
test('momentum conservation for for wsp = 2^(1/2)', () => {
        // molecular model is stable (conservation of momentum) if dt< wsp /omegaMax
        // where omegaMax is the highest oscilation frequency of the molecul in the system 
        // according to Wikipedia wsp should be 2^(1/2)
        dynamicElement1.velocity = new Vector2(10, 0);
        dynamicElement2.mass = 10000000;
        
        for (let i = 1; i < 1000; i++) {
            interaction.springRate = Math.random() * 1000;
            dynamicElement1.mass = Math.random() * 1000;
            dynamicElement2.mass = Math.random() * 1000;
            dynamicElement1.velocity = new Vector2(10, Math.random() * 1000);
            let maximumDt = calculatemaximumDt(interaction.springRate, dynamicElement1.mass, dynamicElement2.mass);
            maximumDt *= 1;
            let momentum0 = dynamicElement1.getMomentum().add(dynamicElement2.getMomentum());
            for (let i = 0; i < 10000; i++) {
                interaction.update();
                dynamicElementUpdater.update(maximumDt);
            }
            let momentum1 = dynamicElement1.getMomentum().add(dynamicElement2.getMomentum());
            expect(momentum0.distanceTo(momentum1) <= 0.01 * momentum0.length()).toBeTruthy();
        }
    });
```
Je偶eli `maximumDt` pomno偶, chocia偶 przez `1.1` to system przestaje by stabilny. 